<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous"/>
  <title>Websocket Demo</title>
</head>
<body>
  <div class="container">
    <h1>Websocket Demo</h1>
    <h2>User Id: <span id="user-id"><em>Not found</em></span></h2>
    <p>
      <h2>Other Users</h2>
      <ul id="user-list">

      </ul>
    </p>
  </div>
  <script>
    const ws = new WebSocket('ws://localhost:3000?room-id=abcd');
    ws.addEventListener('open', (e) => {
      console.log('Open!', e);
    })

    const userList = document.getElementById('user-list');
    function addNewUser(userId){
      const newItem = document.createElement('li');
      newItem.innerText = userId;
      newItem.setAttribute('data-user', userId)
      userList.appendChild(newItem);
    }
    function removeUser(userId){
      const foundItem = userList.querySelector('li[data-user=' + userId + ']');
      if(foundItem) { foundItem.remove(); }
    }
    ws.addEventListener('message', (e) => {
      console.log('Message!', e);
      try {
        const item = JSON.parse(e.data);
        switch(item.type){
          case "CONNECTED": {
            document.getElementById('user-id').innerHTML = item.userId;
            break;
          }
          case "NEW_USER": {
            addNewUser(item.userId);
            break;
          }
          case "CURRENT_USERS": {
            item.userIds.forEach(addNewUser);
            break;
          }
          case "REMOVE_USER": {
            removeUser(item.userId);
            break;
          }
        }
      } catch(e){

      }
    })
  </script>
</body>
</html>